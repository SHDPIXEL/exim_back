<!DOCTYPE html>
<html lang="en">
  <head>
    <% include ../partials/head %>
  </head>
  <body class="hold-transition skin-blue sidebar-mini">
    <div class="wrapper">
      <header class="main-header"><% include ../partials/header %></header>

      <aside class="main-sidebar"><% include ../partials/aside %></aside>

      <div class="content-wrapper">
        <section class="content-header">
          <h1>Manage Selected Ads</h1>
        </section>

        <section class="content">
          <div class="row">
            <div class="col-md-12">
              <div class="box box-info">
                <div class="box-header">
                  <h3 class="box-title">Select Advertisement</h3>
                </div>

                <form
                  id="ads_form"
                  action="/adds/media/store"
                  method="POST"
                  class="form-horizontal"
                >
                  <div class="box-body">
                    <div class="alert alert-danger" style="display: none">
                      <i class="fa fa-warning"></i>
                      <button class="close" data-dismiss="alert">×</button>
                      <span id="errorMsg">Please check your inputs.</span>
                    </div>
                    <div class="alert alert-success" style="display: none">
                      <i class="fa fa-check"></i>
                      <button class="close" data-dismiss="alert">×</button>
                      <span id="successMsg"
                        >Advertisement added successfully!</span
                      >
                    </div>

                    <div class="form-group">
                      <label class="col-md-3 control-label"
                        >Position <span style="color: red">*</span></label
                      >
                      <div class="col-md-6">
                        <select
                          class="form-control"
                          id="position"
                          name="position"
                          required
                        >
                          <option value="Home_Top_Left">Home_Top_Left</option>
                          <option value="Home_Top_Right">Home_Top_Right</option>
                          <option value="Home_AboveEvents_Right">
                            Home_AboveEvents_Right
                          </option>
                          <option value="Home_AboveEvents_Left">
                            Home_AboveEvents_Left
                          </option>
                          <option value="Home_Subscribe">Home_Subscribe</option>
                          <option value="Home_Video">Home_Video</option>
                          <option value="Home_Bottom_Right">
                            Home_Bottom_Right
                          </option>
                          <option value="Home_Bottom_Left">
                            Home_Bottom_Left
                          </option>
                          <option value="News_Details">News_Details</option>
                          <option value="Video_Gallery_Details">
                            Video_Gallery_Details
                          </option>
                          <option value="Home_Above_Headlines">
                            Home_Above_Headlines
                          </option>
                          <option value="News_Bottom_Right">
                            News_Bottom_Right
                          </option>
                          <option value="News_Bottom_Left">
                            News_Bottom_Left
                          </option>
                          <option value="EximIndia_Bottom_Left">
                            EximIndia_Bottom_Left
                          </option>
                          <option value="EximIndia_Bottom_Right">
                            EximIndia_Bottom_Right
                          </option>
                          <option value="OurEditors_Bottom_Left">
                            OurEditors_Bottom_Left
                          </option>
                          <option value="OurEditors_Bottom_Right">
                            OurEditors_Bottom_Right
                          </option>
                          <option value="OurReaders_Bottom_Left">
                            OurReaders_Bottom_Left
                          </option>
                          <option value="OurReaders_Bottom_Right">
                            OurReaders_Bottom_Right
                          </option>
                          <option value="ExchangeRates_Bottom_Left">
                            ExchangeRates_Bottom_Left
                          </option>
                          <option value="ExchangeRates_Bottom_Right">
                            ExchangeRates_Bottom_Right
                          </option>
                          <option value="CustomRates_Bottom_Left">
                            CustomRates_Bottom_Left
                          </option>
                          <option value="CustomRates_Bottom_Right">
                            CustomRates_Bottom_Right
                          </option>
                          <option value="Appointments_Bottom_Left">
                            Appointments_Bottom_Left
                          </option>
                          <option value="Appointments_Bottom_Right">
                            Appointments_Bottom_Right
                          </option>
                          <option value="Video_Gallery_News">
                            Video_Gallery_News
                          </option>
                          <option value="Appointment_Main">
                            Appointment_Main
                          </option>
                          <option value="Category_Bottom_Left">
                            Category_Bottom_Left
                          </option>
                          <option value="Category_Bottom_Right">
                            Category_Bottom_Right
                          </option>
                          <option value="NewsLetter_Top">
                            NewsLetter_Top
                          </option>
                          <option value="NewsLetter_Side">
                            NewsLetter_Side
                          </option>
                        </select>
                      </div>
                    </div>

                    <!-- Start Date -->
                    <div class="form-group">
                      <label class="col-md-3 control-label"
                        >Start Date <span style="color: red">*</span></label
                      >
                      <div class="col-md-6">
                        <input
                          type="date"
                          class="form-control"
                          id="startDate"
                          name="startDate"
                          required
                        />
                      </div>
                    </div>

                    <!-- End Date -->
                    <div class="form-group">
                      <label class="col-md-3 control-label"
                        >End Date <span style="color: red">*</span></label
                      >
                      <div class="col-md-6">
                        <input
                          type="date"
                          class="form-control"
                          id="endDate"
                          name="endDate"
                          required
                        />
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="col-md-3 control-label"
                        >Select Media <span style="color: red">*</span></label
                      >
                      <div class="col-md-6">
                        <button
                          type="button"
                          class="btn btn-primary"
                          data-toggle="modal"
                          data-target="#mediaModal"
                        >
                          Show Images/Videos
                        </button>
                      </div>
                    </div>

                    <input type="hidden" name="mediaUrls" id="mediaUrls" />
                  </div>
                </form>
              </div>
            </div>
          </div>
        </section>
      </div>

      <footer class="main-footer"><% include ../partials/footer %></footer>
    </div>

    <% include ../partials/tail %>

    <!-- Media Modal -->
    <div id="mediaModal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Select Media</h5>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body">
            <h5>Images</h5>
            <div id="imagesContainer"></div>
            <h5>Videos</h5>
            <div id="videosContainer"></div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              id="submitMediaSelection"
              class="btn btn-success"
            >
              <i class="glyphicon glyphicon-check"></i> Save Selection
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              <i class="glyphicon glyphicon-remove"></i> Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        let selectedMedia = [];
        let mediaData = []; // Store API response globally

        // Fetch media when modal opens
        $("#mediaModal").on("show.bs.modal", function () {
          $.get("/adds/media", function (response) {
            console.log("✅ API Response:", response); // Log full API response
            if (response.success) {
              mediaData = response.ads; // Store response in global variable
              let imagesContainer = $("#imagesContainer");
              let videosContainer = $("#videosContainer");
              imagesContainer.empty();
              videosContainer.empty();

              if (mediaData.length === 0) {
                imagesContainer.html("<p>No media available.</p>");
                videosContainer.html("<p>No media available.</p>");
                return;
              }

              mediaData.forEach((ad) => {
                if (ad.media && ad.media.filePath) {
                  let mediaType = ad.media.filePath.match(
                    /\.(mp4|mov|avi|wmv|flv)$/i
                  )
                    ? "video"
                    : "image";

                  if (mediaType === "image") {
                    imagesContainer.append(`
                            <label>
                                <input type="checkbox" name="media" value="${ad.media.filePath}" data-type="image">
                                <img src="${ad.media.filePath}" width="100">
                            </label>
                        `);
                  } else if (mediaType === "video") {
                    videosContainer.append(`
                            <label>
                                <input type="checkbox" name="media" value="${ad.media.filePath}" data-type="video">
                                <video src="${ad.media.filePath}" width="100" controls></video>
                            </label>
                        `);
                  }
                }
              });
            }
          }).fail(function () {
            alert("Error fetching media. Please try again.");
          });
        });

        $("#mediaModal").on("change", "input[name='media']", function () {
          let mediaUrl = $(this).val();
          let mediaType = $(this).data("type");

          // Debugging log
          console.log("Selected mediaUrl:", mediaUrl);

          // Find the corresponding ad object to get its `url`
          let adData = mediaData.find(
            (ad) => ad.media && ad.media.filePath === mediaUrl
          );
          console.log("Matched adData:", adData);

          let url = adData && adData.media ? adData.media.url : ""; // Extract correct URL
          let googleId = adData && adData.media ? adData.media.googleId : "";
          console.log("Extracted URL:", url);
          console.log("Extracted URL:", googleId);

          if ($(this).is(":checked")) {
            selectedMedia.push({
              mediaUrl: mediaUrl,
              mediaType: mediaType,
              url: url, // Store the correct URL
              googleId: googleId, // Store Google ID
              sequenceNumber: selectedMedia.length + 1,
            });
          } else {
            selectedMedia = selectedMedia.filter(
              (media) => media.mediaUrl !== mediaUrl
            );
            selectedMedia.forEach((media, index) => {
              media.sequenceNumber = index + 1;
            });
          }

          console.log("Selected Media:", selectedMedia);
          $("#mediaUrls").val(JSON.stringify(selectedMedia));
        });

        // Submit form with start and end date
        $("#submitMediaSelection").click(function () {
          let startDate = $("#startDate").val();
          let endDate = $("#endDate").val();

          // Validation for Start & End Date
          if (!startDate || !endDate) {
            $("#errorMsg").text("Start and End Date are required.");
            $(".alert-danger").show().delay(3000).fadeOut();
            return;
          }

          // Ensure end date is after start date
          if (new Date(startDate) > new Date(endDate)) {
            $("#errorMsg").text("End Date must be after Start Date.");
            $(".alert-danger").show().delay(3000).fadeOut();
            return;
          }

          if (selectedMedia.length === 0) {
            $("#errorMsg").text("Please select at least one image or video.");
            $(".alert-danger").show().delay(3000).fadeOut();
            return;
          }

          $("#save_ads").prop("disabled", true).text("Saving...");

          let formData = $("#ads_form").serialize();

          $.post("/adds/media/store", formData, function (response) {
            if (!response.success) {
              $("#errorMsg").text(response.message);
              $(".alert-danger").show().delay(3000).fadeOut();
            } else {
              $("#successMsg").text("Selection saved successfully!");
              $(".alert-success").show().delay(3000).fadeOut();

              // Reset fields
              $("input[name='media']").prop("checked", false);
              selectedMedia = [];
              $("#mediaUrls").val("");
              $("#startDate").val("");
              $("#endDate").val("");
              $("#mediaModal").modal("hide");
            }
          })
            .fail(function () {
              $("#errorMsg").text("Something went wrong. Try again.");
              $(".alert-danger").show().delay(3000).fadeOut();
            })
            .always(function () {
              $("#save_ads").prop("disabled", false).text("Save Selection");
            });
        });
      });
    </script>
  </body>
</html>
